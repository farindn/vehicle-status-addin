<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Driving Count Widget</title>
  <!-- 1. Use MyGeotab CSS (Geotab UI Library) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/geotab-ui@1.0.0/dist/geotab-ui.min.css">
  
  <style>
    /* 2. Avoid Global CSS: Scope everything to a specific ID container */
    #my-driving-widget {
      /* Positioning: Overlay on top of the map (Top Right) */
      position: absolute; 
      top: 10px;
      right: 60px; /* Left of the map toggle buttons */
      z-index: 1000; /* Ensure it sits above the map tiles */
      
      /* Visual Style matching Geotab Cards */
      background-color: #ffffff;
      padding: 10px 15px;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Roboto', sans-serif;
      min-width: 150px;
    }

    /* Scoped classes */
    #my-driving-widget .label {
      font-size: 12px;
      color: #5d6673; /* Geotab Dark Grey */
      font-weight: bold;
      text-transform: uppercase;
    }

    #my-driving-widget .count {
      font-size: 24px;
      font-weight: bold;
      color: #25477B; /* Geotab Blue */
    }

    #my-driving-widget .indicator {
      width: 10px;
      height: 10px;
      background-color: #25477B;
      border-radius: 50%;
      display: inline-block;
    }

    #my-driving-widget.hidden {
      display: none !important;
    }
  </style>
</head>
<body>

  <!-- The Widget Container -->
  <div id="my-driving-widget" class="hidden">
    <div class="indicator"></div>
    <div>
      <div class="count" id="drive-count-display">--</div>
      <div class="label">Vehicles Driving</div>
    </div>
  </div>

  <script>
    /**
     * Geotab Add-in Namespace
     * Must match the "name" in your config.json (DrivingCounter)
     */
    geotab.addin.DrivingCounter = function (api, state) {
      
      // DOM References
      var widget = document.getElementById('my-driving-widget');
      var display = document.getElementById('drive-count-display');
      var intervalId = null;

      // Function to fetch data and count
      var updateCount = function() {
        // We use Get<DeviceStatusInfo> as it's lighter than getting all Device logic
        api.call("Get", {
          typeName: "DeviceStatusInfo",
          search: {
             // We only care about current status
             fromDate: new Date().toISOString()
          }
        }, function(results) {
          
          // LOGIC: Count where isDriving === true
          var drivingCount = results.filter(function(deviceStatus) {
            return deviceStatus.isDriving === false;
          }).length;

          // Update UI
          display.innerText = drivingCount;
          console.log("Updated Driving Count: " + drivingCount);

        }, function(error) {
          console.error("Error fetching status:", error);
          display.innerText = "!";
        });
      };

      return {
        /**
         * Initialize runs once when the add-in loads.
         */
        initialize: function (api, state, callback) {
            console.log("DrivingCounter: Initializing");
            callback();
        },

        /**
         * Focus runs when the user views the Map page.
         * 3. Using the 'state' object to understand context if needed.
         */
        focus: function (api, state) {
            console.log("DrivingCounter: Focused. Current Page:", state.page);
            
            // Show the widget
            widget.classList.remove('hidden');

            // Perform immediate update
            updateCount();

            // Set up a refresh interval (e.g., every 30 seconds)
            intervalId = setInterval(updateCount, 30000);
        },

        /**
         * Blur runs when the user leaves the Map page.
         * Important to clear intervals here to save performance.
         */
        blur: function (api, state) {
            console.log("DrivingCounter: Blurred");
            
            // Hide the widget
            widget.classList.add('hidden');

            // Stop the data fetching
            if (intervalId) {
              clearInterval(intervalId);
              intervalId = null;
            }
        }
      };
    };
  </script>
</body>
</html>