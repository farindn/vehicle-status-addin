<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Geotab Bridge</title>
</head>
<body>
    
    <div id="geotab-map-addin-container" style="height:100vh; width:100%; overflow:hidden; position: relative;">
        <div id="loading-overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:white; z-index:10; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <h3 style="color:#333;">Loading Dashboard...</h3>
            <p id="debug-status" style="color:#666; font-size:12px; margin-bottom: 15px;">Initializing...</p>
            
            <button id="manual-retry-btn" onclick="window.retryBridgeSession()" style="padding:10px 20px; background:#25477B; color:white; border:none; border-radius:4px; cursor:pointer;">
                Retry Connection
            </button>
        </div>
    </div>

    <script type="text/javascript">
        console.log("BRIDGE: File loaded (Robust Version).");

        // 1. Define Logic
        var myMapAddinLogic = function (element, contextWrapper, state) {
            
            console.log("BRIDGE: Factory started.");

            // EXTRACT API (Safety Check)
            var api = contextWrapper && contextWrapper.api ? contextWrapper.api : contextWrapper;
            console.log("BRIDGE: API Object:", api);

            // CONFIGURATION
            var TARGET_APP_PAGE = "https://farindn.github.io/vehicle-status-addin/dashboard.html"; 
            
            var isRendered = false;
            var connectionAttempts = 0;

            // --- RENDER LOGIC ---
            var renderDashboard = function() {
                if (isRendered) return;
                
                connectionAttempts++;
                var status = document.getElementById("debug-status");
                var overlay = document.getElementById("loading-overlay");
                var container = document.getElementById("geotab-map-addin-container");

                status.innerText = "Attempt " + connectionAttempts + ": Requesting Session...";
                console.log("BRIDGE: calling api.getSession() - Attempt " + connectionAttempts);

                // WATCHDOG: If session doesn't return in 3 seconds, try again.
                var watchdog = setTimeout(function() {
                    if (!isRendered) {
                        console.warn("BRIDGE: Session timed out. Retrying...");
                        renderDashboard(); 
                    }
                }, 4000);

                // THE CALL
                try {
                    api.getSession(
                        // SUCCESS CALLBACK
                        function(session) {
                            clearTimeout(watchdog); // Stop the timer
                            console.log("BRIDGE: Session Success!", session);
                            
                            var userName = session.userName;
                            var sessionId = session.sessionId;
                            var database = session.database;
                            var server = (api.mobileCaller && api.mobileCaller.server) ? api.mobileCaller.server : window.location.hostname;

                            var iframeUrl = TARGET_APP_PAGE + 
                                            "?userName=" + encodeURIComponent(userName) + 
                                            "&sessionId=" + encodeURIComponent(sessionId) + 
                                            "&database=" + encodeURIComponent(database) + 
                                            "&server=" + encodeURIComponent(server);

                            var iframe = document.createElement('iframe');
                            iframe.src = iframeUrl;
                            iframe.style.width = "100%";
                            iframe.style.height = "100%";
                            iframe.style.border = "none";
                            
                            container.appendChild(iframe);
                            
                            // Hide overlay
                            if(overlay) overlay.style.display = 'none';

                            isRendered = true;
                        },
                        // ERROR CALLBACK (If supported)
                        function(err) {
                            clearTimeout(watchdog);
                            console.error("BRIDGE: Session Error:", err);
                            status.innerText = "Error getting session. Retrying...";
                        }
                    );
                } catch (e) {
                    console.error("BRIDGE: Critical Exception calling getSession", e);
                    status.innerText = "Critical API Error.";
                }
            };

            // Expose retry to the button
            window.retryBridgeSession = function() {
                console.log("BRIDGE: Manual Retry Clicked.");
                renderDashboard();
            };

            // Start automatically after 1 second (give map time to settle)
            setTimeout(renderDashboard, 1000);

            return {
                initialize: function (api, state, callback) {
                    // renderDashboard(); // Rely on the timeout instead to avoid race conditions
                    callback();
                },
                focus: function (api, state) {
                     // renderDashboard(); 
                },
                blur: function () { }
            };
        };

        // 2. Register
        geotab.addin.myMetrics = myMapAddinLogic;
        geotab.addin.mapMetricsTest = myMapAddinLogic;

    </script>
</body>
</html>
