<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Geotab Bridge</title>
</head>
<body>
    
    <div id="geotab-map-addin-container" style="height:100vh; width:100%; overflow:hidden;">
        <h3>Loading Map Dashboard...</h3>
        <p id="debug-status">Waiting for Geotab to connect...</p>
        
        <button id="manual-start-btn" style="display:none; padding:10px; margin-top:20px; cursor:pointer;">
            Force Start Dashboard
        </button>
    </div>

    <script type="text/javascript">
        console.log("BRIDGE: File loaded (Universal Fix).");

        // 1. Define the Logic Function
        var myMapAddinLogic = function (api, state) {
            
            console.log("BRIDGE: Geotab connected! Function found.");
            document.getElementById("debug-status").innerText = "Connecting...";

            var TARGET_APP_PAGE = "https://farindn.github.io/vehicle-status-addin/dashboard.html"; 
            var isRendered = false;

            var renderDashboard = function() {
                if (isRendered) return;
                
                console.log("BRIDGE: Rendering...");
                var container = document.getElementById("geotab-map-addin-container");
                var status = document.getElementById("debug-status");

                status.innerText = "Getting Session...";

                api.getSession(function(session) {
                    var userName = session.userName;
                    var sessionId = session.sessionId;
                    var database = session.database;
                    var server = api.mobileCaller ? api.mobileCaller.server : window.location.hostname;

                    var iframeUrl = TARGET_APP_PAGE + 
                                    "?userName=" + encodeURIComponent(userName) + 
                                    "&sessionId=" + encodeURIComponent(sessionId) + 
                                    "&database=" + encodeURIComponent(database) + 
                                    "&server=" + encodeURIComponent(server);

                    var iframe = document.createElement('iframe');
                    iframe.src = iframeUrl;
                    iframe.style.width = "100%";
                    iframe.style.height = "100%";
                    iframe.style.border = "none";
                    
                    container.innerHTML = ""; 
                    container.appendChild(iframe);
                    isRendered = true;
                });
            };

            return {
                initialize: function (api, state, callback) {
                    renderDashboard();
                    callback();
                },
                focus: function (api, state) {
                    renderDashboard();
                },
                blur: function () { }
            };
        };

        // 2. REGISTER UNDER BOTH NAMES (To catch config mismatches)
        // If your config "name" is "MyMetrics", Geotab looks for myMetrics
        geotab.addin.myMetrics = myMapAddinLogic;
        
        // If your config "name" is "Map Metrics Test", Geotab looks for mapMetricsTest
        geotab.addin.mapMetricsTest = myMapAddinLogic;

        // 3. Debug Helper: Print available namespaces to console
        console.log("BRIDGE: Registered namespaces. Checking geotab.addin:", geotab.addin);

    </script>
</body>
</html>
