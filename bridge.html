<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Geotab Map Add-In Bridge</title>
</head>
<body>
    
    <div id="geotab-map-addin-container" style="height:100vh; width:100%; overflow:hidden; position: relative;">
        <div id="loading-overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:white; z-index:10; display:flex; flex-direction:column; justify-content:center; align-items:center; font-family: sans-serif;">
            <h3 style="color:#25457B;">Fleet Status Overview</h3>
            <p id="debug-status" style="color:#666; font-size:12px;">Syncing...</p>
        </div>
    </div>

    <script type="text/javascript">
        var fleetStatusAddin = function (element, services) {
            
            // CONFIGURATION
            var DASHBOARD_URL = "https://farindn.github.io/vehicle-status-addin/dashboard.html"; 
            
            // SECURITY: Define the exact allowed origin
            var TARGET_ORIGIN = new URL(DASHBOARD_URL).origin;

            var isRendered = false;
            var iframeRef = null;
            
            var apiService = (services && services.api) ? services.api : null;
            var pageService = (services && services.page) ? services.page : null;

            // --- HELPER: FORMAT & SEND ---
            var fetchAndSendGroups = function() {
                if (!pageService || !iframeRef) return;

                pageService.getFilterState().then(function(groups) {
                    var groupIds = groups.map(function(g) { return g.id; }).join(",");
                    console.log("BRIDGE: Sending Group Update:", groupIds);

                    iframeRef.contentWindow.postMessage({
                        type: "FILTER_UPDATE",
                        groups: groupIds
                    }, TARGET_ORIGIN); // Secure Send
                }).catch(function(err) {
                    console.error("BRIDGE: Filter Sync Error", err);
                });
            };

            var renderDashboard = function() {
                if (isRendered) return;
                
                var container = document.getElementById("geotab-map-addin-container");
                var overlay = document.getElementById("loading-overlay");

                if (!container) { setTimeout(renderDashboard, 200); return; }
                if (!apiService || !pageService) return;

                Promise.all([
                    apiService.getSession(),
                    pageService.getFilterState()
                ]).then(function(results) {
                    var session = results[0];
                    var filterGroups = results[1];
                    var groupIds = filterGroups.map(function(g) { return g.id; }).join(",");
                    var server = window.location.hostname;

                    var iframeUrl = DASHBOARD_URL + 
                                    "?userName=" + encodeURIComponent(session.userName) + 
                                    "&sessionId=" + encodeURIComponent(session.sessionId) + 
                                    "&database=" + encodeURIComponent(session.database) + 
                                    "&server=" + encodeURIComponent(server) +
                                    "&groups=" + encodeURIComponent(groupIds);

                    var iframe = document.createElement('iframe');
                    iframe.src = iframeUrl;
                    iframe.style.width = "100%";
                    iframe.style.height = "100%";
                    iframe.style.border = "none";
                    
                    container.appendChild(iframe);
                    iframeRef = iframe; 
                    
                    if (overlay) overlay.style.display = 'none';
                    isRendered = true;

                    // --- ROBUST LISTENER ---
                    pageService.attach('filterChange', function(event) {
                        console.log("BRIDGE: Filter change detected. Fetching new state...");
                        fetchAndSendGroups();
                    });

                }).catch(function(err) {
                    console.error("BRIDGE: Init Failed", err);
                });
            };

            setTimeout(renderDashboard, 500);

            return {
                initialize: function (api, state, callback) { renderDashboard(); if (callback) callback(); },
                focus: function (api, state) { renderDashboard(); },
                blur: function () { }
            };
        };

        geotab.addin.fleetStatusOverview = fleetStatusAddin;
        geotab.addin.myMetrics = fleetStatusAddin;
    </script>
</body>
</html>
